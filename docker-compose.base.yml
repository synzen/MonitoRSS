services:
  feed-requests-redis-cache:
    image: redis:7-alpine
    restart: always
    command: redis-server --save 60 1
    volumes:
      - feed-requests-redis-data:/data
    networks:
      - monitorss-default

  rabbitmq-broker:
    image: rabbitmq:3-management-alpine
    container_name: "rabbitmq-broker"
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 5s
      timeout: 5s
      retries: 20
    networks:
      - monitorss-default
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq

  mongo:
    restart: on-failure:5
    command: mongod --port 27017
    logging:
      driver: none
    image: mongo:8.0
    volumes:
      - "mongodb-data:/data/db"
    networks:
      - monitorss-default

  feed-requests-postgres-db:
    restart: always
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-d", "postgres", "-U", "postgres"]
      timeout: 45s
      interval: 10s
      retries: 10
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    # Comment below to show logs
    logging:
      driver: none
    image: postgres:17-alpine
    volumes:
      - feed-requests-postgres17-data:/var/lib/postgresql/data
    networks:
      - monitorss-default

  bot-presence-service:
    restart: on-failure:5
    build:
      context: services/bot-presence
      dockerfile: Dockerfile
      target: build
    depends_on:
      rabbitmq-broker:
        condition: service_healthy
      mongo:
        condition: service_started
    environment:
      - BOT_PRESENCE_RABBITMQ_URL=${BOT_PRESENCE_RABBITMQ_URL:-amqp://rabbitmq-broker:5672}
    networks:
      - monitorss-default

  discord-rest-listener-service:
    restart: on-failure:10
    build:
      context: services/discord-rest-listener
      dockerfile: Dockerfile
      target: build
    depends_on:
      rabbitmq-broker:
        condition: service_healthy
      mongo:
        condition: service_started
    environment:
      - DISCORD_REST_LISTENER_RABBITMQ_URI=${DISCORD_REST_LISTENER_RABBITMQ_URI:-amqp://rabbitmq-broker:5672}
      - DISCORD_REST_LISTENER_MAX_REQ_PER_SEC=${DISCORD_REST_LISTENER_MAX_REQ_PER_SEC:-40}
    networks:
      - monitorss-default

  feed-requests-postgres-migration:
    restart: on-failure:5
    build:
      context: services/feed-requests
      dockerfile: Dockerfile
      target: build
    command: "npm run migration:up"
    depends_on:
      feed-requests-postgres-db:
        condition: service_started
    environment:
      - FEED_REQUESTS_POSTGRES_URI=${FEED_REQUESTS_POSTGRES_URI:-postgres://postgres:postgres@feed-requests-postgres-db:5432/feedrequests}
      - FEED_REQUESTS_POSTGRES_SCHEMA=${FEED_REQUESTS_POSTGRES_SCHEMA:-feedrequests}
      - FEED_REQUESTS_API_KEY=${FEED_REQUESTS_API_KEY:-feed-requests-api-key}
      - FEED_REQUESTS_API_PORT=${FEED_REQUESTS_API_PORT:-5000}
      - FEED_REQUESTS_RABBITMQ_BROKER_URL=${FEED_REQUESTS_RABBITMQ_BROKER_URL:-amqp://rabbitmq-broker:5672}
      - FEED_REQUESTS_FAILED_REQUEST_DURATION_THRESHOLD_HOURS=${FEED_REQUESTS_FAILED_REQUEST_DURATION_THRESHOLD_HOURS:-48}
      - FEED_REQUESTS_START_TARGET=${FEED_REQUESTS_START_TARGET:-service}
      - FEED_REQUESTS_S3_API_KEY_ID=${FEED_REQUESTS_S3_API_KEY_ID:-1}
      - FEED_REQUESTS_S3_API_KEY=${FEED_REQUESTS_S3_API_KEY:-1}
      - FEED_REQUESTS_REDIS_URI=${FEED_REQUESTS_REDIS_URI:-redis://feed-requests-redis-cache:6379}
      - FEED_REQUESTS_REDIS_DISABLE_CLUSTER=${FEED_REQUESTS_REDIS_DISABLE_CLUSTER:-true}
    networks:
      - monitorss-default

  feed-requests-service:
    restart: on-failure:5
    build:
      context: services/feed-requests
      dockerfile: Dockerfile
      target: build
    healthcheck:
      test: "wget --no-verbose --tries=1 --spider http://127.0.0.1:5000/v1/feed-requests/health || exit 1"
      interval: 5s
      timeout: 5s
      retries: 3
    depends_on:
      feed-requests-postgres-db:
        condition: service_started
      rabbitmq-broker:
        condition: service_healthy
    environment:
      - FEED_REQUESTS_POSTGRES_URI=${FEED_REQUESTS_POSTGRES_URI:-postgres://postgres:postgres@feed-requests-postgres-db:5432/feedrequests}
      - FEED_REQUESTS_POSTGRES_SCHEMA=${FEED_REQUESTS_POSTGRES_SCHEMA:-feedrequests}
      - FEED_REQUESTS_API_KEY=${FEED_REQUESTS_API_KEY:-feed-requests-api-key}
      - FEED_REQUESTS_API_PORT=${FEED_REQUESTS_API_PORT:-5000}
      - FEED_REQUESTS_RABBITMQ_BROKER_URL=${FEED_REQUESTS_RABBITMQ_BROKER_URL:-amqp://rabbitmq-broker:5672}
      - FEED_REQUESTS_FAILED_REQUEST_DURATION_THRESHOLD_HOURS=${FEED_REQUESTS_FAILED_REQUEST_DURATION_THRESHOLD_HOURS:-48}
      - FEED_REQUESTS_REDIS_URI=${FEED_REQUESTS_REDIS_URI:-redis://feed-requests-redis-cache:6379}
      - FEED_REQUESTS_REDIS_DISABLE_CLUSTER=${FEED_REQUESTS_REDIS_DISABLE_CLUSTER:-true}
    networks:
      - monitorss-default

  user-feeds-service:
    restart: on-failure:5
    build:
      context: services/user-feeds
      dockerfile: Dockerfile
      target: build
    depends_on:
      - feed-requests-postgres-db
      - feed-requests-service
      - rabbitmq-broker
    healthcheck:
      test: "wget --no-verbose --tries=1 --spider http://127.0.0.1:5000/v1/user-feeds/health || exit 1"
      interval: 5s
      timeout: 5s
      retries: 3
    environment:
      - USER_FEEDS_POSTGRES_URI=${USER_FEEDS_POSTGRES_URI:-postgres://postgres:postgres@feed-requests-postgres-db:5432}
      - USER_FEEDS_POSTGRES_SCHEMA=${USER_FEEDS_POSTGRES_SCHEMA:-userfeeds}
      - USER_FEEDS_DISCORD_RABBITMQ_URI=${USER_FEEDS_DISCORD_RABBITMQ_URI:-amqp://rabbitmq-broker:5672}
      - USER_FEEDS_POSTGRES_DATABASE=${USER_FEEDS_POSTGRES_DATABASE:-userfeeds}
      - USER_FEEDS_API_PORT=${USER_FEEDS_API_PORT:-5000}
      - USER_FEEDS_RABBITMQ_BROKER_URL=${USER_FEEDS_RABBITMQ_BROKER_URL:-amqp://guest:guest@rabbitmq-broker:5672}
      - USER_FEEDS_FEED_REQUESTS_API_URL=${USER_FEEDS_FEED_REQUESTS_API_URL:-http://feed-requests-service:5000/v1/feed-requests}
      - USER_FEEDS_FEED_REQUESTS_GRPC_URL=${USER_FEEDS_FEED_REQUESTS_GRPC_URL:-dns:///feed-requests-service:4999}
      - USER_FEEDS_FEED_REQUESTS_GRPC_USE_TLS=${USER_FEEDS_FEED_REQUESTS_GRPC_USE_TLS:-false}
      - USER_FEEDS_FEED_REQUESTS_API_KEY=${USER_FEEDS_FEED_REQUESTS_API_KEY:-feed-requests-api-key}
      - USER_FEEDS_API_KEY=${USER_FEEDS_API_KEY:-user-feeds-api-key}
      - USER_FEEDS_REDIS_URI=${USER_FEEDS_REDIS_URI:-redis://feed-requests-redis-cache:6379}
      - USER_FEEDS_REDIS_DISABLE_CLUSTER=${USER_FEEDS_REDIS_DISABLE_CLUSTER:-true}
    networks:
      - monitorss-default

  user-feeds-postgres-migration:
    restart: on-failure:5
    build:
      context: services/user-feeds
      dockerfile: Dockerfile
      target: build
    command: npm run migration:up
    depends_on:
      - feed-requests-postgres-db
    environment:
      - USER_FEEDS_POSTGRES_URI=${USER_FEEDS_POSTGRES_URI:-postgres://postgres:postgres@feed-requests-postgres-db:5432}
      - USER_FEEDS_POSTGRES_SCHEMA=${USER_FEEDS_POSTGRES_SCHEMA:-userfeeds}
      - USER_FEEDS_DISCORD_RABBITMQ_URI=${USER_FEEDS_DISCORD_RABBITMQ_URI:-amqp://rabbitmq-broker:5672}
      - USER_FEEDS_POSTGRES_DATABASE=${USER_FEEDS_POSTGRES_DATABASE:-userfeeds}
      - USER_FEEDS_API_PORT=${USER_FEEDS_API_PORT:-5000}
      - USER_FEEDS_RABBITMQ_BROKER_URL=${USER_FEEDS_RABBITMQ_BROKER_URL:-amqp://guest:guest@rabbitmq-broker:5672}
      - USER_FEEDS_FEED_REQUESTS_API_URL=${USER_FEEDS_FEED_REQUESTS_API_URL:-http://feed-requests-service:5000/v1/feed-requests}
      - USER_FEEDS_FEED_REQUESTS_GRPC_URL=${USER_FEEDS_FEED_REQUESTS_GRPC_URL:-dns:///feed-requests-service:4999}
      - USER_FEEDS_FEED_REQUESTS_GRPC_USE_TLS=${USER_FEEDS_FEED_REQUESTS_GRPC_USE_TLS:-false}
      - USER_FEEDS_FEED_REQUESTS_API_KEY=${USER_FEEDS_FEED_REQUESTS_API_KEY:-feed-requests-api-key}
      - USER_FEEDS_API_KEY=${USER_FEEDS_API_KEY:-user-feeds-api-key}
      - USER_FEEDS_REDIS_URI=${USER_FEEDS_REDIS_URI:-redis://feed-requests-redis-cache:6379}
      - USER_FEEDS_REDIS_DISABLE_CLUSTER=${USER_FEEDS_REDIS_DISABLE_CLUSTER:-true}
    networks:
      - monitorss-default

  user-feeds-next-service:
    restart: on-failure:5
    build:
      context: services/user-feeds-next
      dockerfile: Dockerfile
    depends_on:
      - feed-requests-postgres-db
      - feed-requests-service
      - rabbitmq-broker
    healthcheck:
      test: "wget --no-verbose --tries=1 --spider http://127.0.0.1:5000/v1/user-feeds/health || exit 1"
      interval: 5s
      timeout: 5s
      retries: 3
    environment:
      - USER_FEEDS_POSTGRES_URI=${USER_FEEDS_POSTGRES_URI:-postgres://postgres:postgres@feed-requests-postgres-db:5432/userfeeds}
      - USER_FEEDS_API_PORT=${USER_FEEDS_API_PORT:-5000}
      - USER_FEEDS_RABBITMQ_BROKER_URL=${USER_FEEDS_RABBITMQ_BROKER_URL:-amqp://guest:guest@rabbitmq-broker:5672}
      - USER_FEEDS_FEED_REQUESTS_API_URL=${USER_FEEDS_FEED_REQUESTS_API_URL:-http://feed-requests-service:5000/v1/feed-requests}
      - USER_FEEDS_FEED_REQUESTS_API_KEY=${USER_FEEDS_FEED_REQUESTS_API_KEY:-feed-requests-api-key}
      - USER_FEEDS_API_KEY=${USER_FEEDS_API_KEY:-user-feeds-api-key}
      - USER_FEEDS_REDIS_URI=${USER_FEEDS_REDIS_URI:-redis://feed-requests-redis-cache:6379}
      - USER_FEEDS_REDIS_DISABLE_CLUSTER=${USER_FEEDS_REDIS_DISABLE_CLUSTER:-true}
    networks:
      - monitorss-default

  user-feeds-next-postgres-migration:
    restart: on-failure:5
    build:
      context: services/user-feeds-next
      dockerfile: Dockerfile
    command: node ./dist/src/scripts/run-migrations.js
    depends_on:
      - feed-requests-postgres-db
    environment:
      - USER_FEEDS_POSTGRES_URI=${USER_FEEDS_POSTGRES_URI:-postgres://postgres:postgres@feed-requests-postgres-db:5432/userfeeds}
    networks:
      - monitorss-default

  # Schedule emitter (legacy backend-api)
  schedule-emitter-service:
    build:
      context: services/backend-api
      dockerfile: dockerfiles/web/mixed.Dockerfile
      target: build
    restart: on-failure:10
    depends_on:
      - mongo
      - rabbitmq-broker
    environment:
      - BACKEND_API_USER_FEEDS_API_HOST=${BACKEND_API_USER_FEEDS_API_HOST:-----IRRELEVANT----}
      - BACKEND_API_USER_FEEDS_API_KEY=${BACKEND_API_USER_FEEDS_API_KEY:-----IRRELEVANT----}
      - BACKEND_API_FEED_REQUESTS_API_HOST=${BACKEND_API_FEED_REQUESTS_API_HOST:-----IRRELEVANT----}
      - BACKEND_API_FEED_REQUESTS_API_KEY=${BACKEND_API_FEED_REQUESTS_API_KEY:-----IRRELEVANT----}
      - BACKEND_API_DISCORD_REDIRECT_URI=${BACKEND_API_DISCORD_REDIRECT_URI:-----IRRELEVANT----}
      - BACKEND_API_DEFAULT_MAX_FEEDS=${BACKEND_API_DEFAULT_MAX_FEEDS:-10}
      - BACKEND_API_FEED_USER_AGENT=${BACKEND_API_FEED_USER_AGENT:-----IRRELEVANT----}
      - BACKEND_API_RABBITMQ_BROKER_URL=${BACKEND_API_RABBITMQ_BROKER_URL:-amqp://guest:guest@rabbitmq-broker:5672/}
    networks:
      - monitorss-default
    command: npm run start:schedule-emitter

  # Schedule emitter (backend-api-next)
  schedule-emitter-next-service:
    build:
      context: .
      dockerfile: services/backend-api-next/dockerfiles/mixed.Dockerfile
    restart: on-failure:10
    depends_on:
      - mongo
      - rabbitmq-broker
    environment:
      - BACKEND_API_DEFAULT_MAX_FEEDS=${BACKEND_API_DEFAULT_MAX_FEEDS:-10}
      - BACKEND_API_RABBITMQ_BROKER_URL=${BACKEND_API_RABBITMQ_BROKER_URL:-amqp://guest:guest@rabbitmq-broker:5672/}
      - BACKEND_API_USER_FEEDS_API_HOST=${BACKEND_API_USER_FEEDS_API_HOST:-http://user-feeds-service:5000}
      - BACKEND_API_USER_FEEDS_API_KEY=${BACKEND_API_USER_FEEDS_API_KEY:-user-feeds-api-key}
      - BACKEND_API_FEED_REQUESTS_API_HOST=${BACKEND_API_FEED_REQUESTS_API_HOST:-http://feed-requests-service:5000}
      - BACKEND_API_FEED_REQUESTS_API_KEY=${BACKEND_API_FEED_REQUESTS_API_KEY:-feed-requests-api-key}
      - BACKEND_API_FEED_USER_AGENT=${BACKEND_API_FEED_USER_AGENT:-MonitoRSS}
    networks:
      - monitorss-default
    command: ["node", "dist/scripts/schedule-emitter.js"]

  # Web API (backend-api-next)
  web-api-next:
    build:
      context: .
      dockerfile: services/backend-api-next/dockerfiles/mixed.Dockerfile
    restart: on-failure:3
    depends_on:
      - mongo
      - rabbitmq-broker
    healthcheck:
      test: "wget --no-verbose --tries=1 --spider http://127.0.0.1:${BACKEND_API_PORT:-8000}/api/v1/health || exit 1"
      interval: 5s
      timeout: 5s
      retries: 3
    environment:
      - BACKEND_API_PORT=${BACKEND_API_PORT:-8000}
      - BACKEND_API_DEFAULT_MAX_FEEDS=${BACKEND_API_DEFAULT_MAX_FEEDS:-10}
      - BACKEND_API_RABBITMQ_BROKER_URL=${BACKEND_API_RABBITMQ_BROKER_URL:-amqp://guest:guest@rabbitmq-broker:5672/}
      - BACKEND_API_USER_FEEDS_API_HOST=${BACKEND_API_USER_FEEDS_API_HOST:-http://user-feeds-service:5000}
      - BACKEND_API_USER_FEEDS_API_KEY=${BACKEND_API_USER_FEEDS_API_KEY:-user-feeds-api-key}
      - BACKEND_API_FEED_REQUESTS_API_HOST=${BACKEND_API_FEED_REQUESTS_API_HOST:-http://feed-requests-service:5000}
      - BACKEND_API_FEED_REQUESTS_API_KEY=${BACKEND_API_FEED_REQUESTS_API_KEY:-feed-requests-api-key}
      - BACKEND_API_FEED_USER_AGENT=${BACKEND_API_FEED_USER_AGENT:-MonitoRSS}
    networks:
      - monitorss-default
    command: ["node", "dist/main.js"]

  # Web API (legacy backend-api)
  web-api:
    build:
      context: services/backend-api
      dockerfile: dockerfiles/web/mixed.Dockerfile
      target: build
    restart: on-failure:3
    depends_on:
      - mongo
      - rabbitmq-broker
    ports:
      - "${BACKEND_API_PORT:-8000}:${BACKEND_API_PORT:-8000}"
    environment:
      - BACKEND_API_PORT=${BACKEND_API_PORT:-8000}
    networks:
      - monitorss-default
    command: npm run start:watch

  # Web client (React frontend served by Vite dev server)
  web-client:
    build:
      context: services/backend-api
      dockerfile: dockerfiles/web/mixed.Dockerfile
      target: build
    working_dir: /usr/src/app/client
    restart: on-failure:3
    ports:
      - "3000:3000"
    environment:
      - API_PROXY_URL=http://web-api:${BACKEND_API_PORT:-8000}
    command: npm run dev -- --host 0.0.0.0
    networks:
      - monitorss-default

volumes:
  mongodb-data:
  rabbitmq-data:
  feed-requests-postgres17-data:
  feed-requests-redis-data:
  fs-s3-storage-data:
    driver: local

networks:
  monitorss-default:
    driver: bridge
